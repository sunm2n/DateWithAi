<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: layout(~{::title}, ~{::content}, ~{::scripts})}">
<head>
    <title th:text="${character.name} + '와의 대화 - DateWithAI'">대화 - DateWithAI</title>
</head>
<body>
    <th:block th:fragment="content">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex align-items-center">
                            <img th:src="${character.profileImageUrl != null ? character.profileImageUrl : '/images/default-avatar.png'}" 
                                 class="rounded-circle me-3" style="width: 40px; height: 40px; object-fit: cover;" 
                                 th:alt="${character.name}">
                            <div>
                                <h5 class="mb-0" th:text="${character.name}">캐릭터 이름</h5>
                                <small th:text="${character.age + '세 ' + (character.occupation != null ? character.occupation : '')}">나이, 직업</small>
                            </div>
                            <div class="ms-auto">
                                <button class="btn btn-outline-light btn-sm" onclick="clearChat()">
                                    <i class="fas fa-refresh"></i> 대화 초기화
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body p-0">
                        <div id="chatMessages" class="chat-messages" style="height: 500px; overflow-y: auto; padding: 20px;">
                            <div class="text-center text-muted">
                                <i class="fas fa-comment-dots fa-2x mb-3"></i>
                                <p>새로운 대화를 시작해보세요!</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <form id="chatForm" class="d-flex">
                            <input type="hidden" id="characterId" th:value="${character.id}">
                            <input type="text" id="messageInput" class="form-control me-2" 
                                   placeholder="메시지를 입력하세요..." required>
                            <button type="submit" class="btn btn-primary" id="sendButton">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-user"></i> 캐릭터 정보
                        </h5>
                    </div>
                    <div class="card-body">
                        <img th:src="${character.profileImageUrl != null ? character.profileImageUrl : '/images/default-avatar.png'}" 
                             class="img-fluid rounded mb-3" th:alt="${character.name}">
                        
                        <h6 th:text="${character.name}">캐릭터 이름</h6>
                        <p class="text-muted small" th:text="${character.age + '세, ' + (character.occupation != null ? character.occupation : '무직')}">나이, 직업</p>
                        
                        <h6 class="mt-3">성격</h6>
                        <p class="small" th:text="${character.personality}">성격 설명</p>
                        
                        <h6 class="mt-3">말투</h6>
                        <p class="small" th:text="${character.speakingStyle}">말투 설명</p>
                        
                        <div th:if="${character.background != null}" class="mt-3">
                            <h6>배경 이야기</h6>
                            <p class="small" th:text="${character.background}">배경 설명</p>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-cog"></i> 채팅 설정
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="autoScroll" checked>
                            <label class="form-check-label" for="autoScroll">
                                자동 스크롤
                            </label>
                        </div>
                        
                        <hr>
                        
                        <button class="btn btn-outline-danger btn-sm w-100" onclick="clearChat()">
                            <i class="fas fa-trash"></i> 대화 기록 지우기
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </th:block>
    
    <th:block th:fragment="scripts">
        <style>
            .chat-messages {
                background-color: #f8f9fa;
            }
            
            .message {
                margin-bottom: 15px;
            }
            
            .user-message {
                text-align: right;
            }
            
            .user-message .message-content {
                background-color: #007bff;
                color: white;
                padding: 10px 15px;
                border-radius: 20px 20px 5px 20px;
                display: inline-block;
                max-width: 70%;
                word-wrap: break-word;
            }
            
            .ai-message .message-content {
                background-color: white;
                color: #333;
                padding: 10px 15px;
                border-radius: 20px 20px 20px 5px;
                display: inline-block;
                max-width: 70%;
                word-wrap: break-word;
                border: 1px solid #dee2e6;
            }
            
            .message-time {
                font-size: 0.8em;
                color: #6c757d;
                margin-top: 5px;
            }
        </style>
        
        <script>
            const chatForm = document.getElementById('chatForm');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const chatMessages = document.getElementById('chatMessages');
            const characterId = document.getElementById('characterId').value;
            
            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const message = messageInput.value.trim();
                if (!message) return;
                
                sendButton.disabled = true;
                messageInput.disabled = true;
                
                // 사용자 메시지 추가
                addMessage(message, 'USER');
                messageInput.value = '';
                
                try {
                    const formData = new FormData();
                    formData.append('characterId', characterId);
                    formData.append('message', message);
                    
                    const response = await fetch('/chat/api/send', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        addMessage(result.response, 'AI');
                    } else {
                        addMessage('죄송합니다. 응답을 생성하는 중 오류가 발생했습니다.', 'AI');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    addMessage('네트워크 오류가 발생했습니다. 다시 시도해주세요.', 'AI');
                }
                
                sendButton.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
            });
            
            function addMessage(content, type) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type === 'USER' ? 'user-message' : 'ai-message'}`;
                
                const now = new Date();
                const timeString = now.getHours().toString().padStart(2, '0') + ':' + 
                                 now.getMinutes().toString().padStart(2, '0');
                
                messageDiv.innerHTML = `
                    <div class="message-content">${content}</div>
                    <div class="message-time">${timeString}</div>
                `;
                
                chatMessages.appendChild(messageDiv);
                
                // 자동 스크롤
                if (document.getElementById('autoScroll').checked) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }
            
            function clearChat() {
                if (confirm('대화 기록을 모두 지우시겠습니까?')) {
                    chatMessages.innerHTML = `
                        <div class="text-center text-muted">
                            <i class="fas fa-comment-dots fa-2x mb-3"></i>
                            <p>새로운 대화를 시작해보세요!</p>
                        </div>
                    `;
                }
            }
            
            // 엔터키로 메시지 전송
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    chatForm.dispatchEvent(new Event('submit'));
                }
            });
            
            // 페이지 로드 시 스크롤을 맨 아래로
            document.addEventListener('DOMContentLoaded', () => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
                messageInput.focus();
            });
        </script>
    </th:block>
</body>
</html>